---
  
# When power is detected, and the washing machine is not in 
# the Running state, change the status of the washing machine
# to Running. 
# The status check will ensure we don't try to put the state 
# to Running each time the power level changes, and we're already
# in the Running state.
 
- alias: Set washing machine active when power detected
  trigger:
    - platform: numeric_state
      entity_id: sensor.washer_power
      above: 15
  condition:
    - condition: template
      value_template: "{{ states.sensor.washer_state.state != 'Running' }}"
  action:
    - service: mqtt.publish
      data:
        topic: hass/state/washer
        payload: 'Running'
        retain: 'true'

# When the power drops, move the state of the washing machine to 
# Finishing.
 
- alias: Set washing machine finished when power drops
  trigger:
    - platform: numeric_state
      entity_id: sensor.washer_power
      below: 6
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: sensor.washer_state
        state: Running
  action:
    - service: mqtt.publish
      data:
        topic: hass/state/washer
        payload: 'Finishing'
        retain: 'true'

# Wait 8 minutes for us to be in the Finishing state before we
# decide the washing machine has finished. This way, if the 
# washing machine is in between cycles and the power drops, we 
# won't mark the washing machine cycle as finished too early.
 
- alias: Set washing machine clean after timeout
  trigger:
    - platform: state
      entity_id: sensor.washer_state
      to: Finishing
      for:
        minutes: 5
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: sensor.washer_state
        state: Finishing
  action:
    - service: mqtt.publish
      data:
        topic: hass/state/washer
        payload: 'Clean'
        retain: 'true'

- alias: Set washing machine idle after emptied
  trigger:
  - platform: state
    entity_id: sensor.washer_door_state
    to: 'Door Open'
  condition:
    - condition: state
      entity_id: sensor.washer_state
      state: Clean
  action:
    - service: mqtt.publish
      data:
        topic: hass/state/washer
        payload: 'Idle'
        retain: 'true'
